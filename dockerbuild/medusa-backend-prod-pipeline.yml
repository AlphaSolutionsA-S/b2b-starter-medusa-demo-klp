trigger:
 - manual

resources:
- repo: self


variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: '851c7833-15a2-4c6a-b5e6-50046b8748d6'
  imageRepository: 'medusa_backend_prodb2b-starter-medusa-demo-klp'
  containerRegistry: 'alphasolutions.azurecr.io'
  dockerfilePath: 'dockerbuild/Dockerfile-backend'
  tag: '$(Build.BuildId)'
  node.env: 'production'

pool:
  vmImage: ubuntu-latest

steps:
- task: NodeTool@0
  inputs:
    versionSource: 'spec'
    versionSpec: '20.x'

- script: |
    cd backend
    corepack enable
    yarn install 
    yarn build
  displayName: 'yarn install and build'


- task: CopyFiles@2
  inputs:
    sourceFolder: '$(Build.SourcesDirectory)/backend/.medusa/server'
    contents: |
       **
    targetFolder: '$(Build.ArtifactStagingDirectory)'
  displayName: 'Copy output files'



- task: PublishPipelineArtifact@1
  inputs:
    artifactName: medusa-server
    targetPath: '$(Build.ArtifactStagingDirectory)'
    publishLocation: 'pipeline'
  displayName: 'Publish medusa artifact'

  # Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker


- task: Docker@2
  displayName: Build and push an image to container registry
  inputs:
    command: buildAndPush
    repository: $(imageRepository)
    dockerfile: $(dockerfilePath)
    buildContext: $(Build.ArtifactStagingDirectory)
    containerRegistry: $(dockerRegistryServiceConnection)
    tags: |
      $(tag)
      latest
